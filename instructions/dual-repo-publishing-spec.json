{
  "id": "dual-repo-publishing-spec",
  "title": "Dual-Repo Publishing — Org-Wide Specification",
  "body": "# Dual-Repo Publishing — Org-Wide Specification\n\nOrganization-wide pattern for private-dev → public-publication repository mirroring. All jagilber-org repos MUST follow this pattern.\n\n## Pattern Overview\n\n- **Private dev repo** (`{name}-dev`): All development — issues, PRs, branches, CI logs, internal docs\n- **Public pub repo** (`{name}`): Read-only publication mirror — code, docs, LICENSE, tagged releases only\n- **Publish workflow**: GitHub Actions in dev repo, triggers on release tags (`v*`), syncs filtered content to pub repo\n\n## Naming Convention\n\n| Private (dev) | Public (publication) |\n|---|---|\n| `{repo}-dev` | `{repo}` (original name preserved for URL stability) |\n\nPublic repo names stay unchanged so existing links, stars, and forks remain valid.\n\n## Publish Exclusion List (.publish-exclude)\n\nDefault paths stripped from publication:\n\n```\n.specify/\nspecs/\n.github/ISSUE_TEMPLATE/\n.github/workflows/publish.yml\n.secrets.baseline\n.pre-commit-config.yaml\n.publish-exclude\n.pii-allowlist\nstate/\nlogs/\nmeta/\nbackups/\nagents/\nskills/\nautomation/\nconfig/\nseed/\n```\n\nRepos MAY add project-specific exclusions. Repos MUST NOT remove default exclusions.\n\n## Constitution Article (PB — Publishing)\n\n```json\n{\n  \"id\": \"publishing\",\n  \"title\": \"Dual-Repo Publishing\",\n  \"rules\": [\n    { \"id\": \"PB-1\", \"description\": \"All active repos MUST follow the dual-repo pattern: private dev repo for all development, public pub repo as read-only mirror\", \"enforced\": true },\n    { \"id\": \"PB-2\", \"description\": \"Public publication repos MUST NOT receive direct pushes; all updates MUST flow through the publish workflow from the dev repo\", \"enforced\": true },\n    { \"id\": \"PB-3\", \"description\": \"Internal artifacts (.specify/, specs/, issue templates, state/, logs/) MUST be excluded from publication via .publish-exclude\", \"enforced\": true },\n    { \"id\": \"PB-4\", \"description\": \"Publish workflow MUST only trigger on release tags (v*); automated publishes on every commit are prohibited\", \"enforced\": true },\n    { \"id\": \"PB-5\", \"description\": \"Public repos MUST have issues, wiki, and projects disabled; CONTRIBUTING.md MUST explain the contribution policy\", \"enforced\": true }\n  ]\n}\n```\n\n## Migration Sequence (per repo)\n\n### For existing public repos:\n\n1. **Create** `{repo}-dev` as private repo in jagilber-org\n2. **Mirror** all branches and tags: `git push --mirror {repo}-dev`\n3. **Set** `{repo}-dev` to private: `gh repo edit jagilber-org/{repo}-dev --visibility private`\n4. **Add** `.publish-exclude` and `publish.yml` workflow to `{repo}-dev`\n5. **Scrub** `{repo}` public: force-push cleaned main (strip .specify/, specs/, internal files)\n6. **Disable** issues/wiki/projects on `{repo}`: `gh repo edit --enable-issues=false --enable-wiki=false --enable-projects=false`\n7. **Protect** `{repo}` main branch (only publish action can push)\n8. **Update** README.md and CONTRIBUTING.md with publication mirror notice\n9. **Test**: Create release tag on `{repo}-dev`, verify publish syncs correctly\n\n### For already-private repos (e.g., mcp-agent-manager):\n\n1. **Rename** to `{repo}-dev`: `gh repo rename {repo}-dev`\n2. **Create** `{repo}` as new public repo\n3. **Add** `.publish-exclude` and `publish.yml` workflow to `{repo}-dev`\n4. **Run** initial publish to populate public repo\n5. **Configure** public repo (disable issues, branch protection, notices)\n\n## Migration Order\n\nOrdered by risk (lowest first):\n\n1. **chrome-screenshot-sanitizer** — Pilot (simplest, no SpecKit, no tests)\n2. **kusto-dashboard-manager** — Low risk (Python, no copilot-instructions)\n3. **powershell-mcp-server** — Medium (TypeScript, tests)\n4. **obfuscate-mcp-server** — Medium (TypeScript, largest test suite)\n5. **mcp-index-server** — High (SpecKit, active dependency, open issues)\n6. **mcp-agent-manager** — Special case (already private, needs public mirror)\n\nThe `.github` org repo is **exempt** — it must remain public as the org profile.\n\n## Pre-Migration: SpecKit Bootstrap\n\nRepos without SpecKit governance MUST be bootstrapped before migration. See `speckit-repo-bootstrap` runbook.\n\nBootstrap adds: constitution.json, .specify/, pre-commit hooks, copilot-instructions.md, functional verification (Section 8.5).\n\n## Publish Workflow Template\n\n```yaml\nname: Publish to Public Mirror\non:\n  push:\n    tags: ['v*']\njobs:\n  publish:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n      - name: Filter and publish\n        env:\n          PUBLISH_PAT: ${{ secrets.PUBLISH_PAT }}\n        run: |\n          # Read exclusion list\n          while IFS= read -r pattern; do\n            [[ \"$pattern\" =~ ^#.*$ || -z \"$pattern\" ]] && continue\n            rm -rf \"$pattern\"\n          done < .publish-exclude\n          \n          # Configure git\n          git config user.name \"publish-bot\"\n          git config user.email \"publish-bot@jagilber-org\"\n          \n          # Push to public repo\n          PUBLIC_REPO=\"${GITHUB_REPOSITORY%-dev}\"\n          git remote add public \"https://x-access-token:${PUBLISH_PAT}@github.com/${PUBLIC_REPO}.git\"\n          git add -A\n          git commit -m \"Publish ${GITHUB_REF_NAME}\" --allow-empty\n          git tag -f \"${GITHUB_REF_NAME}\"\n          git push public main --force\n          git push public \"${GITHUB_REF_NAME}\" --force\n```\n\n## Rollback\n\nIf migration fails:\n1. Rename `{repo}-dev` back to `{repo}`: `gh repo rename {repo}`\n2. Restore visibility: `gh repo edit --visibility public`\n3. Re-enable issues/wiki: `gh repo edit --enable-issues --enable-wiki`\n4. Delete the failed public repo if created\n\n## Open Questions\n\n- **Stars/forks**: Rename transfers stars but new public repo starts at 0. Fork strategy preserves stars but adds complexity.\n- **External contributions**: Read-only mirrors or accept PRs on public repos?\n- **npm packages**: Audit before migrating repos that publish packages.\n\n## Related Instructions\n\n- `speckit-repo-bootstrap` — Full bootstrap runbook (prerequisite for unmanaged repos)\n- `speckit-constitution-template` — Constitution template with PB article\n- `speckit-folder-reference` — .specify/ folder layout",
  "priority": 8,
  "audience": "all",
  "requirement": "critical",
  "categories": [
    "governance",
    "publishing",
    "migration",
    "cross-repo"
  ],
  "primaryCategory": "governance",
  "contentType": "instruction",
  "schemaVersion": "3",
  "version": "1.0.0",
  "status": "approved",
  "owner": "system",
  "priorityTier": "P1",
  "classification": "internal",
  "semanticSummary": "Organization-wide dual-repo publishing specification: private dev repos for all development activity, public repos as read-only publication mirrors via GitHub Actions publish workflow on release tags. Includes migration sequence, exclusion list, constitution article, and rollback procedures.",
  "reviewIntervalDays": 90,
  "changeLog": [
    {
      "version": "1.0.0",
      "changedAt": "2026-02-16T00:00:00.000Z",
      "summary": "Initial creation — full dual-repo publishing spec with migration sequence, publish workflow, exclusion list, PB constitution article, and rollback"
    }
  ],
  "updatedAt": "2026-02-16T00:00:00.000Z"
}
